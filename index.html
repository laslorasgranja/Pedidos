import React, { useState, useEffect } from 'react';
import { ShoppingCart, Trash2, Plus, Minus, ArrowLeft, Check, Truck, Store, MapPin, User, Banknote, Search, X, AlertCircle } from 'lucide-react';

const CarniceriaApp = () => {
  // --- Configuraci√≥n y Datos ---
  const CONFIG = {
    nombreNegocio: "Las Loras Granja",
    telefono: "5491128948821", // N√∫mero actualizado
    alias: "GRANJA.CAMPO.FRESCA",
    cbu: "0000003100000000000000",
    costoEnvio: 1500,
    montoEnvioGratis: 30000,
  };

  const PRODUCTOS = [
    { id: 1, nombre: "Nalga", precioKg: 9000, categoria: "Milanesas" },
    { id: 2, nombre: "Cuadrada", precioKg: 9000, categoria: "Milanesas" },
    { id: 3, nombre: "Bola de Lomo", precioKg: 9000, categoria: "Milanesas" },
    { id: 4, nombre: "Cuadril", precioKg: 9000, categoria: "Cortes" },
    { id: 5, nombre: "Asado", precioKg: 8500, categoria: "Parrilla" },
    { id: 6, nombre: "Vac√≠o", precioKg: 9200, categoria: "Parrilla" },
    { id: 7, nombre: "Carne Picada Especial", precioKg: 7000, categoria: "Diario" },
    { id: 8, nombre: "Chorizo Puro Cerdo", precioKg: 6000, categoria: "Embutidos" },
  ];

  // --- Estados ---
  const [carrito, setCarrito] = useState([]);
  const [vista, setVista] = useState('tienda'); // tienda, carrito
  const [tipoEntrega, setTipoEntrega] = useState('retiro'); // retiro, domicilio
  const [mensajeExito, setMensajeExito] = useState(false);
  const [busqueda, setBusqueda] = useState('');
  
  // Estados para manejo de persistencia (carrito guardado)
  const [showResumeModal, setShowResumeModal] = useState(false);
  const [pendingCart, setPendingCart] = useState([]);
  const [isInitialized, setIsInitialized] = useState(false);

  // --- Opciones de Peso ---
  const opcionesPeso = [
    { label: "1/4 kg", valor: 0.25 },
    { label: "1/2 kg", valor: 0.50 },
    { label: "3/4 kg", valor: 0.75 },
    { label: "1 kg", valor: 1.00 },
  ];

  // --- Efectos para Persistencia ---
  
  // 1. Al cargar la p√°gina, revisar si hay algo guardado
  useEffect(() => {
    const saved = localStorage.getItem('carrito_granja');
    if (saved) {
      try {
        const parsed = JSON.parse(saved);
        if (parsed.length > 0) {
          setPendingCart(parsed);
          setShowResumeModal(true);
          return; 
        }
      } catch (e) {
        console.error("Error al leer carrito guardado", e);
      }
    }
    setIsInitialized(true); // Si no hay nada guardado, inicializamos normal
  }, []);

  // 2. Guardar autom√°ticamente cada vez que cambia el carrito (solo si ya se inicializ√≥)
  useEffect(() => {
    if (isInitialized) {
      localStorage.setItem('carrito_granja', JSON.stringify(carrito));
    }
  }, [carrito, isInitialized]);

  // --- Manejadores del Modal de Restauraci√≥n ---
  const handleResumeCart = () => {
    setCarrito(pendingCart);
    setIsInitialized(true);
    setShowResumeModal(false);
  };

  const handleNewCart = () => {
    setCarrito([]);
    localStorage.removeItem('carrito_granja');
    setIsInitialized(true);
    setShowResumeModal(false);
  };


  // --- Funciones Auxiliares ---
  const formatPrecio = (valor) => {
    return new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS', minimumFractionDigits: 0 }).format(valor);
  };

  const calcularTotalProductos = () => {
    return carrito.reduce((total, item) => total + (item.precioKg * item.cantidad), 0);
  };

  const calcularCostoEnvio = () => {
    if (tipoEntrega === 'retiro') return 0;
    const subtotal = calcularTotalProductos();
    return subtotal >= CONFIG.montoEnvioGratis ? 0 : CONFIG.costoEnvio;
  };

  const calcularTotalFinal = () => {
    return calcularTotalProductos() + calcularCostoEnvio();
  };

  // --- L√≥gica del Carrito ---
  const agregarAlCarrito = (producto, peso) => {
    const itemExistenteIndex = carrito.findIndex(item => item.id === producto.id && item.pesoSeleccionado === peso);
    
    if (itemExistenteIndex >= 0) {
      const nuevoCarrito = [...carrito];
      nuevoCarrito[itemExistenteIndex].cantidad += 1; // Sumamos una unidad de ese peso
      setCarrito(nuevoCarrito);
    } else {
      setCarrito([...carrito, { 
        ...producto, 
        pesoSeleccionado: peso, 
        cantidad: 1,
        cartId: Date.now() // ID √∫nico para el carrito
      }]);
    }
    
    // Peque√±a animaci√≥n visual (feedback)
    setMensajeExito(true);
    setTimeout(() => setMensajeExito(false), 1500);
  };

  const eliminarDelCarrito = (cartId) => {
    setCarrito(carrito.filter(item => item.cartId !== cartId));
  };

  const enviarPedidoWhatsApp = () => {
    const linea = "%0A";
    let mensaje = `Hola *${CONFIG.nombreNegocio}*, quiero realizar el siguiente pedido:${linea}${linea}`;
    
    carrito.forEach(item => {
      const pesoTexto = opcionesPeso.find(op => op.valor === item.pesoSeleccionado)?.label || `${item.pesoSeleccionado}kg`;
      mensaje += `‚ñ™Ô∏è ${item.cantidad}x ${item.nombre} (${pesoTexto}) - ${formatPrecio(item.precioKg * item.pesoSeleccionado * item.cantidad)}${linea}`;
    });

    const costoEnvio = calcularCostoEnvio();
    mensaje += `${linea}*Subtotal Productos:* ${formatPrecio(calcularTotalProductos())}`;
    
    if (tipoEntrega === 'domicilio') {
        mensaje += `${linea}*Env√≠o (a coordinar):* ${costoEnvio === 0 ? 'GRATIS' : formatPrecio(costoEnvio)}`;
    }
    
    mensaje += `${linea}*TOTAL ESTIMADO: ${formatPrecio(calcularTotalFinal())}*${linea}${linea}`;
    
    if (tipoEntrega === 'domicilio') {
        mensaje += `(Opci√≥n seleccionada: Env√≠o a domicilio)${linea}`;
    } else {
        mensaje += `(Opci√≥n seleccionada: Retiro por el local)${linea}`;
    }

    mensaje += `${linea}Les paso mis datos y direcci√≥n por ac√° para coordinar el pago y la entrega.`;

    // Limpiamos el carrito local al enviar, asumiendo que ya se proces√≥
    // Opcional: si prefieres que quede hasta que ellos lo borren manualmente, comenta las siguientes dos l√≠neas.
    // setCarrito([]);
    // localStorage.removeItem('carrito_granja');

    window.open(`https://wa.me/${CONFIG.telefono}?text=${mensaje}`, '_blank');
  };

  // --- Filtrado de Productos ---
  const productosFiltrados = PRODUCTOS.filter(producto => 
    producto.nombre.toLowerCase().includes(busqueda.toLowerCase())
  );

  // --- Componentes de Vista ---

  // 1. Cabecera
  const Header = () => (
    <div className="bg-green-800 text-white p-4 sticky top-0 z-50 shadow-md flex justify-between items-center">
      <div>
        <h1 className="text-xl font-bold">{CONFIG.nombreNegocio}</h1>
        <p className="text-xs text-green-200">Calidad de campo</p>
      </div>
      <div className="relative cursor-pointer" onClick={() => setVista('carrito')}>
        <div className="bg-white text-green-800 p-2 rounded-full">
          <ShoppingCart size={24} />
        </div>
        {carrito.length > 0 && (
          <span className="absolute -top-1 -right-1 bg-yellow-400 text-green-900 font-bold text-xs w-5 h-5 flex items-center justify-center rounded-full">
            {carrito.length}
          </span>
        )}
      </div>
    </div>
  );

  // 2. Tarjeta de Producto
  const ProductoCard = ({ producto }) => {
    const [peso, setPeso] = useState(1.00);

    return (
      <div className="bg-white rounded-lg shadow-md border border-gray-200 p-4 mb-4">
        <div className="flex justify-between items-start mb-2">
          <h3 className="text-lg font-bold text-gray-800">{producto.nombre}</h3>
          <span className="bg-green-100 text-green-800 text-sm font-semibold px-2 py-1 rounded">
            {formatPrecio(producto.precioKg)}/kg
          </span>
        </div>
        
        <div className="text-gray-600 text-sm mb-3">
          Seleccion√° la cantidad:
        </div>

        <div className="grid grid-cols-4 gap-2 mb-4">
          {opcionesPeso.map((op) => (
            <button
              key={op.label}
              onClick={() => setPeso(op.valor)}
              className={`py-2 text-sm rounded-md font-medium transition-colors ${
                peso === op.valor 
                  ? 'bg-green-700 text-white shadow-sm' 
                  : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
              }`}
            >
              {op.label}
            </button>
          ))}
        </div>

        <div className="flex justify-between items-center bg-gray-50 p-3 rounded-lg">
          <div className="text-sm text-gray-600">
            Total estimado:<br/>
            <span className="text-lg font-bold text-gray-900">
              {formatPrecio(producto.precioKg * peso)}
            </span>
          </div>
          <button
            onClick={() => agregarAlCarrito(producto, peso)}
            className="bg-green-600 active:bg-green-700 text-white px-6 py-2 rounded-lg font-bold flex items-center gap-2 shadow-sm"
          >
            <Plus size={20} /> AGREGAR
          </button>
        </div>
      </div>
    );
  };

  // --- Renderizado Principal ---

  return (
    <div className="min-h-screen bg-gray-50 pb-20 font-sans flex flex-col justify-between">
      
      {/* Modal de Recuperaci√≥n de Carrito */}
      {showResumeModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 z-[60] flex items-center justify-center p-4">
          <div className="bg-white rounded-xl shadow-2xl p-6 max-w-sm w-full animate-in fade-in zoom-in duration-300">
            <div className="flex flex-col items-center text-center mb-6">
              <div className="bg-yellow-100 p-3 rounded-full mb-4">
                <AlertCircle className="text-yellow-600" size={32} />
              </div>
              <h3 className="text-xl font-bold text-gray-900">¬øQuer√©s continuar tu compra?</h3>
              <p className="text-gray-600 mt-2">
                Encontramos productos que elegiste en tu visita anterior.
              </p>
            </div>
            
            <div className="space-y-3">
              <button 
                onClick={handleResumeCart}
                className="w-full bg-green-600 text-white py-3 rounded-lg font-bold hover:bg-green-700 transition-colors"
              >
                S√≠, recuperar productos
              </button>
              <button 
                onClick={handleNewCart}
                className="w-full bg-gray-100 text-gray-600 py-3 rounded-lg font-bold hover:bg-gray-200 transition-colors"
              >
                No, empezar de cero
              </button>
            </div>
          </div>
        </div>
      )}

      <div>
      {/* Notificaci√≥n Flotante */}
      {mensajeExito && (
        <div className="fixed top-20 left-1/2 transform -translate-x-1/2 bg-green-600 text-white px-6 py-3 rounded-full shadow-xl z-50 font-medium flex items-center gap-2 animate-bounce">
          <Check size={20} /> ¬°Producto agregado!
        </div>
      )}

      {/* Vista: Tienda (Listado) */}
      {vista === 'tienda' && (
        <>
          <Header />
          <div className="p-4 max-w-md mx-auto">
            <div className="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-6 rounded shadow-sm">
              <p className="font-bold text-lg mb-2">üõí ¬øC√≥mo hacer tu pedido?</p>
              <ul className="space-y-2 text-sm">
                <li>1. Primero toc√° el peso que quer√©s (1/4, 1/2, 1 kilo, etc).</li>
                <li><strong>2. Toc√° el bot√≥n verde "AGREGAR". Si quer√©s llevar m√°s cantidad (por ejemplo 2 kilos), volv√© a tocar el bot√≥n las veces que necesites.</strong></li>
                <li>3. Cuando termines de elegir todo, toc√° el dibujo del changuito arriba a la derecha.</li>
              </ul>
            </div>

            {/* Barra de B√∫squeda */}
            <div className="mb-6 relative">
              <Search className="absolute left-3 top-3.5 text-gray-400" size={20} />
              <input 
                type="text" 
                placeholder="¬øQu√© est√°s buscando? (Ej: Asado)" 
                className="w-full p-3 pl-10 border-2 border-green-600 rounded-lg text-lg focus:outline-none focus:ring-2 focus:ring-green-400 bg-white"
                value={busqueda}
                onChange={(e) => setBusqueda(e.target.value)}
              />
              {busqueda && (
                <button 
                  onClick={() => setBusqueda('')}
                  className="absolute right-3 top-3.5 text-gray-400"
                >
                  <X size={20} />
                </button>
              )}
            </div>

            {productosFiltrados.length > 0 ? (
              productosFiltrados.map(prod => (
                <ProductoCard key={prod.id} producto={prod} />
              ))
            ) : (
              <div className="text-center py-8 text-gray-500">
                <p className="text-lg">No encontramos productos con ese nombre.</p>
                <button 
                  onClick={() => setBusqueda('')}
                  className="mt-2 text-green-700 font-bold underline"
                >
                  Ver todos los productos
                </button>
              </div>
            )}
          </div>
          
          {/* Bot√≥n flotante inferior para ver carrito si hay productos */}
          {carrito.length > 0 && (
            <div className="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 p-4 shadow-lg z-40 max-w-md mx-auto">
               <button 
                onClick={() => setVista('carrito')}
                className="w-full bg-green-800 text-white py-3 rounded-xl font-bold text-lg shadow-md flex justify-between px-6"
               >
                 <span>Ver mi Pedido ({carrito.length})</span>
                 <span>{formatPrecio(calcularTotalProductos())}</span>
               </button>
            </div>
          )}
        </>
      )}

      {/* Vista: Carrito */}
      {vista === 'carrito' && (
        <div className="max-w-md mx-auto bg-white">
          <div className="bg-gray-100 p-4 flex items-center gap-4 sticky top-0 shadow-sm z-10">
            <button onClick={() => setVista('tienda')} className="p-2 bg-white rounded-full shadow text-gray-700">
              <ArrowLeft size={24} />
            </button>
            <h2 className="text-xl font-bold text-gray-800">Tu Pedido</h2>
          </div>

          <div className="p-4">
            {carrito.length === 0 ? (
              <div className="text-center py-10 text-gray-500">
                <ShoppingCart size={64} className="mx-auto mb-4 text-gray-300" />
                <p className="text-lg">El carrito est√° vac√≠o</p>
                <button onClick={() => setVista('tienda')} className="mt-4 text-green-700 font-bold underline">
                  Volver a ver productos
                </button>
              </div>
            ) : (
              <>
                <div className="space-y-4 mb-8">
                  {carrito.map((item) => {
                    const labelPeso = opcionesPeso.find(o => o.valor === item.pesoSeleccionado)?.label;
                    return (
                      <div key={item.cartId} className="flex justify-between items-center border-b border-gray-100 pb-4">
                        <div>
                          <h4 className="font-bold text-lg">{item.nombre}</h4>
                          <div className="text-gray-600">
                            {item.cantidad} x {labelPeso} <span className="text-xs text-gray-400">({formatPrecio(item.precioKg)}/kg)</span>
                          </div>
                        </div>
                        <div className="flex items-center gap-3">
                          <span className="font-bold text-lg text-gray-800">
                            {formatPrecio(item.precioKg * item.pesoSeleccionado * item.cantidad)}
                          </span>
                          <button 
                            onClick={() => eliminarDelCarrito(item.cartId)}
                            className="bg-red-50 text-red-600 p-2 rounded-full"
                          >
                            <Trash2 size={20} />
                          </button>
                        </div>
                      </div>
                    );
                  })}
                </div>

                <div className="bg-gray-50 p-4 rounded-xl mb-6">
                   <h3 className="font-bold text-lg mb-3">¬øC√≥mo quer√©s recibirlo?</h3>
                   <div className="flex gap-2">
                      <button 
                        onClick={() => setTipoEntrega('retiro')}
                        className={`flex-1 p-3 rounded-lg border-2 flex flex-col items-center gap-2 ${tipoEntrega === 'retiro' ? 'border-green-700 bg-green-50 text-green-900' : 'border-gray-200 bg-white text-gray-500'}`}
                      >
                        <Store size={24} />
                        <span className="font-bold text-sm">Retiro en Local</span>
                      </button>
                      <button 
                        onClick={() => setTipoEntrega('domicilio')}
                        className={`flex-1 p-3 rounded-lg border-2 flex flex-col items-center gap-2 ${tipoEntrega === 'domicilio' ? 'border-green-700 bg-green-50 text-green-900' : 'border-gray-200 bg-white text-gray-500'}`}
                      >
                        <Truck size={24} />
                        <span className="font-bold text-sm">Env√≠o a Casa</span>
                      </button>
                   </div>
                   
                   {tipoEntrega === 'domicilio' && (
                     <div className="mt-3 text-sm text-gray-600 bg-white p-3 rounded border border-gray-200">
                        {calcularTotalProductos() >= CONFIG.montoEnvioGratis ? (
                           <span className="text-green-600 font-bold flex items-center gap-1">
                             <Check size={16} /> ¬°Ten√©s env√≠o GRATIS!
                           </span>
                        ) : (
                           <span>Costo de env√≠o estimado: <strong>{formatPrecio(CONFIG.costoEnvio)}</strong><br/>
                           <span className="text-xs text-orange-600">Faltan {formatPrecio(CONFIG.montoEnvioGratis - calcularTotalProductos())} para env√≠o gratis.</span>
                           </span>
                        )}
                     </div>
                   )}
                </div>

                <div className="border-t border-gray-200 pt-4 space-y-2 text-lg">
                   <div className="flex justify-between text-gray-600">
                     <span>Subtotal</span>
                     <span>{formatPrecio(calcularTotalProductos())}</span>
                   </div>
                   {tipoEntrega === 'domicilio' && (
                    <div className="flex justify-between text-gray-600">
                      <span>Env√≠o (estimado)</span>
                      <span>{calcularCostoEnvio() === 0 ? 'Bonificado' : formatPrecio(calcularCostoEnvio())}</span>
                    </div>
                   )}
                   <div className="flex justify-between font-bold text-2xl text-gray-900 pt-2">
                     <span>Total Estimado</span>
                     <span>{formatPrecio(calcularTotalFinal())}</span>
                   </div>
                   <p className="text-xs text-center text-gray-500 mt-2">
                     * El costo final y el pago se coordinan por WhatsApp
                   </p>
                </div>

                <button 
                  onClick={enviarPedidoWhatsApp}
                  className="w-full bg-green-600 hover:bg-green-700 text-white py-4 rounded-xl font-bold text-lg shadow-lg flex items-center justify-center gap-2 animate-pulse mt-8"
                >
                  <img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg" alt="WA" className="w-6 h-6" />
                  ENVIAR PEDIDO A WHATSAPP
                </button>
                <p className="text-center text-sm text-gray-500 mt-4 px-4">
                  Al tocar el bot√≥n se abrir√° WhatsApp con el pedido listo. Ah√≠ podr√°s pasar tus datos y direcci√≥n.
                </p>
              </>
            )}
          </div>
        </div>
      )}
      </div>

      {/* Footer / Cr√©ditos */}
      <footer className="w-full text-center py-6 mt-4 border-t border-gray-200">
        <p className="text-gray-500 text-sm mb-1">
          ¬© 2026 {CONFIG.nombreNegocio}. Todos los derechos reservados.
        </p>
        <p className="text-gray-500 text-sm">
          Sitio hecho por <a href="https://www.juanmartinbarrientos.com/" target="_blank" rel="noopener noreferrer" className="font-bold text-green-800 hover:underline">JMB</a>
        </p>
      </footer>
    </div>
  );
};

export default CarniceriaApp;